<!-- <button onclick="test_decode()">test decode</button>
<br>
<button onclick="test_encode()">test encode</button>
<br>
<button onclick="test_all()">test all</button> -->
<h2>wNFT 生成工具 ｜ wNFT ring tool</h2>
<br>
Wrap 合约地址: <input id="contractAddressInput" style="width: 400px" />
<br>
token id: <input id="tokenIdInput" />
<br>
<button onclick="encode_wnft()">生成 wnft 头像 (encode wnft)</button>
<br>
<!-- <button onclick="decode_wnft()">decode wnft</button> -->

<script src="dist/test.js"></script>
<script>
  const encode_wnft = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
      const reader = new FileReader();
      reader.readAsDataURL(e.target.files[0]);

      reader.onload = async () => {
        const img = new Image();
        img.src = reader.result;

        const raw = new BitArray(256);
        
        const address = document.querySelector('#contractAddressInput').value;
        const tokenId = document.querySelector('#tokenIdInput').value;
        console.log('address', address, 'tokenId', tokenId);

        // bitArray: [ 20 bytes contract address, 000...000, tokenId in 32bit ]
        const addressHexString = address.replace('0x', '');
        [...addressHexString].forEach((c, index) => {
          console.log(c, index);
          raw.set(
            [...parseInt(c, 16).toString(2).padStart(4, '0')].map(bit => +bit),
            index * 4
          )
        });

        raw.set(
          [...(+tokenId).toString(2).padStart(32, '0')].map(bit => +bit),
          224
        );

        setTimeout(() => {
          const ringImage = write(img, raw);
        document.body.appendChild(ringImage);
        console.log('raw', raw.toString());

        const data = parse(ringImage);
        const bitString = data.toString();
        const contractAddressBits = bitString.slice(0, 160);
        let contractAddress = '0x';
        for (let i = 0; i < 40; i++) {
          const startIndex = i * 4;
          contractAddress += parseInt(contractAddressBits.slice(startIndex, startIndex + 4), 2).toString(16);
        }
        console.log('contract address decoded: ', contractAddress);

        const decodedTokenId = parseInt(bitString.slice(224), 2);
        console.log('decoded token id: ', decodedTokenId);
        }, 300)
      };
    };

    input.click();
  }

  const test_all = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
      const reader = new FileReader();
      reader.readAsDataURL(e.target.files[0]);

      reader.onload = async () => {
        const img = new Image();
        img.src = reader.result;

        const raw = new BitArray(256);
        raw.set(
          [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
          ],
          0
        );
        raw.set(
          [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1,
          ],
          64
        );
        raw.set(
          [
            1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
          ],
          128
        );
        raw.set(
          [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
          ],
          192
        );

        console.log('onload', img);

        const newImage = write(img, raw);
        document.body.appendChild(newImage);

        // decode testing
        const data = parse(newImage);
        console.log('raw length', raw.toString().length);
        console.log('data length', data.toString().length);
        if (raw.toString() === data.toString()) {
          console.log('equals');
        } else {
          console.log('not equal');
        }
        console.log('decoded', data.toString());
      };
    };

    input.click();
  }

  const test_decode = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
      const reader = new FileReader();
      reader.readAsDataURL(e.target.files[0]);
      reader.onload = async () => {
        const img = new Image();
        img.src = reader.result;
        setTimeout(() => {
          const data = parse(img);
          console.log(data.toString());

          const bitString = data.toString();
          const contractAddressBits = bitString.slice(0, 160);
          let contractAddress = '0x';
          for (let i = 0; i < 40; i++) {
            const startIndex = i * 4;
            contractAddress += parseInt(contractAddressBits.slice(startIndex, startIndex + 4), 2).toString(16);
          }
          console.log('contract address decoded: ', contractAddress);

          const decodedTokenId = parseInt(bitString.slice(224), 2);
          console.log('decoded token id: ', decodedTokenId);
        }, 100)
      };
    };
    input.click();
  };

  const test_encode = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
      const reader = new FileReader();
      reader.readAsDataURL(e.target.files[0]);

      reader.onload = async () => {
        const img = new Image();
        img.src = reader.result;

        const raw = new BitArray(256);
        // raw.set(
        //   [
        //     1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        //     1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        //     1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        //   ],
        //   0
        // );
        raw.set(
          [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
          ],
          64
        );
        // raw.set(
        //   [
        //     1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        //     1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        //     1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        //   ],
        //   128
        // );
        raw.set(
          [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
          ],
          192
        );

        document.body.appendChild(write(img, raw));
      };
    };

    input.click();
  };
</script>
